<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceTracker Pro - Personal Finance Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/dashboardnav.css}">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <script th:inline="javascript">
        let monthlyIncome = /*[[${monthlyIncome}]]*/ {};
        let monthlyExpenses = /*[[${monthlyExpenses}]]*/ {};
        let monthlySavings = /*[[${monthlySavings}]]*/ {};
        let categoryTotals = /*[[${categoryTotals}]]*/ {};
    </script>
</head>

<body>
    <!-- Navigation -->
    <section>
        <nav class="nav">
            <div class="nav-container">
                <div class="logo">FinanceTracker Pro</div>
                <ul class="nav-links">
                    <li><a href="/newHome">Home</a></li>
                    <li><a href="/analysis">Features</a></li>
                    <li><a href="#users">For You</a></li>
                    <li><a href="#pricing">Pricing</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
                <a th:href="@{/transactions/income/add}" class="cta-nav">Add Income</a>
                <a th:href="@{/transactions/expense/add}" class="cta-nav">Add Expense</a>
                <a th:href="@{/logout}" class="cta-nav">Logout</a>
            </div>
        </nav>
    </section>
    <br />
    <br />
    <br />
    <br />
    <div class="nav-buttons">
        <button class="nav-btn">Transactions</button>
        <button class="nav-btn">Budgets</button>
        <button class="nav-btn">Goals</button>
        <button class="nav-btn">Reports</button>
        <button class="nav-btn">Settings</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value positive">₹<span th:text="${balance}">0.00</span></div>
            <div class="stat-label">Total Balance</div>
        </div>
        <div class="stat-card">
            <div class="stat-value positive">₹<span th:text="${totalIncome}">0.00</span></div>
            <div class="stat-label">Monthly Income</div>
        </div>
        <div class="stat-card">
            <div class="stat-value negative">₹<span th:text="${totalExpense}">0.00</span></div>
            <div class="stat-label">Monthly Expenses</div>
        </div>
        <div class="stat-card">
            <div class="stat-value positive">₹<span th:text="${savings}">0.00</span></div>
            <div class="stat-label">Monthly Savings</div>
        </div>
    </div>


    <div class="charts-grid">
        <div class="chart-container">
            <h3 class="chart-title">Monthly Cash Flow</h3>
            <div class="canvas-container">
                <canvas id="cashFlowChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">Expense Categories</h3>
            <div class="canvas-container">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <!-- <div class="chart-container">
            <h3 class="chart-title">Budget vs Actual</h3>
            <div class="canvas-container">
                <canvas id="budgetChart"></canvas>
            </div>
        </div> -->

        <div class="chart-container">
            <h3 class="chart-title">Savings Growth</h3>
            <div class="canvas-container">
                <canvas id="savingsChart"></canvas>
            </div>
        </div>
    </div>
    <div class="transactions-section">
        <h3 class="chart-title">Recent Transactions</h3>
        <table class="transactions-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="transaction : ${transactions}">
                    <td th:text="${transaction.date}">01-Aug-2025</td>
                    <td th:text="${transaction.description}">Job</td>
                    <td th:text="${transaction.category}">Salary</td>
                    <td th:text="'₹' + ${#numbers.formatDecimal(transaction.amount, 0, 2)}"
                        th:classappend="${transaction.type == 'INCOME'} ? 'transaction-amount income' : 'transaction-amount expense'">
                    </td>
                </tr>
            </tbody>

        </table>
    </div>
    </div>

    <!-- Chatbot Button -->
    <div id="chatbot-btn">💬</div>

    <!-- Chatbot Window -->
    <div id="chatbot-window"
        style="display:none; width:300px; height:400px; border:1px solid #ccc; border-radius:8px; position:fixed; bottom:70px; right:20px; background:#fff; flex-direction:column;">

        <div id="chatbot-header">AI Assistant</div>
        <div id="chatbot-messages"></div>
        <div id="chatbot-input-container">
            <input type="text" id="chatbot-input" placeholder="Ask me anything..." />
            <button id="chatbot-send">Send</button>
        </div>
    </div>



    <script>
        // Chart.js configuration
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.color = '#666';

        // Cash Flow Chart
        const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
        new Chart(cashFlowCtx, {
            type: 'line',
            data: {
                labels: Object.keys(monthlyIncome),
                datasets: [
                    {
                        label: 'Income',
                        data: Object.values(monthlyIncome),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: 'Expenses',
                        data: Object.values(monthlyExpenses),
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    }
                ]
            }
        });

        // Expense Categories Chart
        const expenseCtx = document.getElementById('expenseChart').getContext('2d');

        new Chart(expenseCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(categoryTotals),
                datasets: [{
                    data: Object.values(categoryTotals),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#6f42c1',
                        '#00bcd4', '#8bc34a', '#e91e63', '#9e9e9e'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#333',
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const value = context.parsed;
                                const label = context.label || '';
                                return `${label}: ₹${value.toLocaleString()}`;
                            }
                        }
                    }
                },
                cutout: '65%' // Adjusts donut thickness
            }
        });
        // Savings Growth Chart
        const savingsCtx = document.getElementById('savingsChart').getContext('2d');
        new Chart(savingsCtx, {
            type: 'line',
            data: {
                labels: Object.keys(monthlySavings),
                datasets: [{
                    label: 'Total Savings',
                    data: Object.values(monthlySavings),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3
                }]
            }
        });

        // Navigation functionality
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Hover effects for stat cards
        document.querySelectorAll('.stat-card').forEach(card => {
            card.addEventListener('mouseenter', () => card.style.transform = 'translateY(-8px) scale(1.02)');
            card.addEventListener('mouseleave', () => card.style.transform = 'translateY(0) scale(1)');
        });

        document.addEventListener("DOMContentLoaded", () => {
            // DOM elements
            const chatbotBtn = document.getElementById("chatbot-btn");
            const chatbotWindow = document.getElementById("chatbot-window");
            const chatbotMessages = document.getElementById("chatbot-messages");
            const chatbotInput = document.getElementById("chatbot-input");
            const chatbotSend = document.getElementById("chatbot-send");

            // User name (Thymeleaf variable fallback to 'User')
            const userName = /*[[${#authentication?.name}]]*/ 'User';

            // Start hidden
            chatbotWindow.style.display = "none";

            // Add message function
            function addMessage(sender, text) {
                const msg = document.createElement("div");
                msg.style.margin = "8px 0";
                msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
                chatbotMessages.appendChild(msg);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                return msg; // for typing effect
            }

            // Typing simulation
            function simulateTyping(messageElement, fullText) {
                let index = 0;
                messageElement.innerHTML = `<strong>AI:</strong> `;
                const interval = setInterval(() => {
                    messageElement.innerHTML = `<strong>AI:</strong> ${fullText.slice(0, index)}<span class="blinking-cursor">|</span>`;
                    index++;
                    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
                    if (index > fullText.length) {
                        clearInterval(interval);
                        messageElement.innerHTML = `<strong>AI:</strong> ${fullText}`;
                    }
                }, 30);
            }

            // Toggle chatbot window with greeting
            chatbotBtn.addEventListener("click", () => {
                const isHidden = chatbotWindow.style.display === "none";
                if (isHidden) {
                    chatbotWindow.style.display = "flex";
                    if (!chatbotMessages.dataset.greeted) {
                        const typingMsg = addMessage("AI", "");
                        simulateTyping(typingMsg, `Hello, ${userName}! 👋 How can I help you today?`);
                        chatbotMessages.dataset.greeted = "true";
                    }
                } else {
                    chatbotWindow.style.display = "none";
                }
            });

            // Send message function
            async function sendMessage() {
                const text = chatbotInput.value.trim();
                if (!text) return;

                addMessage("You", text);
                chatbotInput.value = "";

                const typingMsg = addMessage("AI", "Typing...");

                try {
                    // Call your backend API
                    const response = await fetch("/chatbot/query?question=" + encodeURIComponent(text));
                    const answer = await response.text();
                    simulateTyping(typingMsg, answer);
                } catch (error) {
                    simulateTyping(typingMsg, "⚠️ Sorry, I couldn't connect right now.");
                }
            }

            // Send on click or Enter
            chatbotSend.addEventListener("click", sendMessage);
            chatbotInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
        });
    </script>
</body>

</html>